<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="../sessions.js" defer></script>
</head>
<body>

  <div class="container mt-5">
    <h2>Your Cart</h2>
    <div id="cartItems" class="mt-4"></div>
    <div id="cartSummary" class="mt-4"></div>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || user.role !== 'customer') {
      alert("Only customers can access this page.");
      window.location.href = "/login.html";
    }

    const productIds = JSON.parse(localStorage.getItem('cart')) || [];
    const quantityMap = {};

    // Build quantity object (initially 1 per item)
    productIds.forEach(id => {
      quantityMap[id] = (quantityMap[id] || 0) + 1;
    });

    if (productIds.length === 0) {
      document.getElementById('cartItems').innerHTML = '<p>Your cart is empty.</p>';
    } else {
      fetch('/api/products/all') // we'll add this route to get product details
        .then(res => res.json())
        .then(products => {
          const cartProducts = products.filter(p => productIds.includes(p.id));
          let total = 0;

          const cartHTML = cartProducts.map(product => {
            const qty = quantityMap[product.id];
            const subtotal = qty * product.price;
            total += subtotal;

            return `
              <div class="card mb-3">
                <div class="card-body d-flex justify-content-between align-items-center">
                  <div>
                    <h5>${product.name}</h5>
                    <p>R${product.price} x ${qty} = <strong>R${subtotal.toFixed(2)}</strong></p>
                  </div>
                  <div>
                    <button onclick="changeQty(${product.id}, -1)" class="btn btn-sm btn-outline-secondary">-</button>
                    <button onclick="changeQty(${product.id}, 1)" class="btn btn-sm btn-outline-secondary">+</button>
                    <button onclick="removeItem(${product.id})" class="btn btn-sm btn-danger">Remove</button>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          document.getElementById('cartItems').innerHTML = cartHTML;
          document.getElementById('cartSummary').innerHTML = `
            <h4>Total: R${total.toFixed(2)}</h4>
            <button class="btn btn-primary" onclick="placeOrder()">Place Order</button>
          `;
        });
    }

    function changeQty(id, delta) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      if (delta > 0) {
        cart.push(id);
      } else {
        const index = cart.indexOf(id);
        if (index !== -1) cart.splice(index, 1);
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      window.location.reload();
    }

    function removeItem(id) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      cart = cart.filter(pid => pid !== id);
      localStorage.setItem('cart', JSON.stringify(cart));
      window.location.reload();
    }

    function placeOrder() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      if (cart.length === 0) return alert("Cart is empty.");

      fetch('/api/orders/place', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customerId: user.id, products: cart })
      })
        .then(res => res.json())
        .then(result => {
          alert("Order placed!");
          localStorage.removeItem('cart');
          window.location.href = "/customer/index.html";
        })
        .catch(err => {
          console.error(err);
          alert("Failed to place order.");
        });
    }
  </script>

</body>
</html>
